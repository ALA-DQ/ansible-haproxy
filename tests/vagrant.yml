# test file for haproxy
---
- hosts: all
  remote_user: vagrant
  sudo: true
  roles:
    - haproxy
  vars:
    # ssl (file) map
    haproxy_ssl_map:
      - src: ../../../files/haproxy/etc/haproxy/ssl/star-taalzee-nl.pem
        dest: /etc/ssl/private/star-rekentuin-nl.pem
      - src: ../../../files/haproxy/etc/haproxy/ssl/star-taalzee-nl.pem
        dest: /etc/ssl/private/star-taalzee-nl.pem
      - src: ../../../files/haproxy/etc/haproxy/ssl/star-wordsandbirds-nl.pem
        dest: /etc/ssl/private/star-wordsandbirds-nl.pem

    # listen section
    haproxy_listen:
      - name: stats
        description: Global statistics
        bind: '127.0.0.1:1936'
        mode: http
        stats:
          enable: true
          uri: /
          hide_version: true
          refresh: 5s
          auth:
            - user: admin
              passwd: '*rAp*uWRUt!a'
        ssl:
          - crt: star-taalzee-nl.pem

    # front-end section
    haproxy_frontend:
      - name: http
        description: Front-end for all HTTP traffic
        bind: '0.0.0.0:80'
        mode: http
        default_backend: webservers
      - name: https
        description: Front-end for all HTTPS traffic
        bind: '0.0.0.0:443'
        ssl:
          - crt: star-rekentuin-nl.pem
          - crt: star-taalzee-nl.pem
          - crt: star-wordsandbirds-nl.pem
        mode: http
        default_backend: webservers
        rspadd:
          - string: 'Strict-Transport-Security:\ max-age=15768000'
            # cond:

    # back-end section
    haproxy_backend:
      - name: webservers
        description: Back-end with all (Apache) webservers
        mode: http
        balance: roundrobin
        option:
          - forwardfor
          - 'httpchk HEAD / HTTP/1.1\r\nHost:localhost'
        http_request:
          - action: 'set-header'
            param: 'X-Forwarded-Port %[dst_port]'
          - action: 'add-header'
            param: 'X-Forwarded-Proto https'
            cond: 'if { ssl_fc }'
        server:
          - name: web01
            ip: 127.0.0.1
            port: 8001
            # maxconn: 501
            params:
              - check
          - name: web02
            ip: 127.0.0.1
            port: 8002
            # maxconn: 502
            params:
              - check
          - name: web03
            ip: 127.0.0.1
            port: 8003
            # maxconn: 503
            params:
              - check
          - name: web04
            ip: 127.0.0.1
            port: 8004
            # maxconn: 504
            params:
              - check
